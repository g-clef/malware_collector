import os
import requests
from bs4 import BeautifulSoup

from malware_collector import MalwareCollector


class VXVaultCollector(MalwareCollector):
    # collect malware from http://vxvault.net/ViriList.php .

    base_url = "http://vxvault.net/"
    list_url = base_url + "ViriList.php"

    def __init__(self):
        super(VXVaultCollector, self).__init__()
        self.base_path = self.configfile.get("VXVault", "path")

    def get(self):
        base_list = requests.get(self.list_url)
        soup = BeautifulSoup(base_list.content, features='html.parser')
        table = soup.find("table")
        for row in table.find_all('tr'):
            th = row.find("th")
            if th is not None:
                continue
            anchors = row.find_all("a")
            for a in anchors:
                if "href" not in a.attrs:
                    continue
                href = a.attrs['href']
                if not href.endswith(".zip"):
                    continue
                filename = href.split("/")[-1]
                download_url = self.base_url + href
                full_saved_path = os.path.join(self.base_path, filename)
                if not os.path.exists(full_saved_path):
                    response = requests.get(download_url, stream=True)
                    with open(full_saved_path, "wb") as fileHandle:
                        for chunk in response.iter_content(chunk_size=8192):
                            fileHandle.write(chunk)
                    print(f"downloaded {filename}")


if __name__ == "__main__":
    vx = VXVaultCollector()
    vx.get()
