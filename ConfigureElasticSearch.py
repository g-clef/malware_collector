import os

import certifi
import elasticsearch


def _connect_to_es(host, user, password):
    # TODO: Fix getting a CA/shared cert set up.
    # the ES cluster is created with a self-signed cert by default.
    es = elasticsearch.Elasticsearch(host,
                                     http_auth=(user, password),
                                     verify_certs=False,
                                     use_ssl=True,
                                     ssl_show_warn=False,
                                     port=9200,
                                     ca_certs=certifi.where())
    return es


def set_configurations(host, user, password):
    command = {"index_patterns": "malwaretl-*",
               "settings": {
                   "index.mapping.total_fields.limit": 2000
               },
               "mappings": {
                   "properties": {
                       "results": {
                           "properties": {
                               "workers": {
                                   "properties": {
                                       "lief": {
                                           "properties": {
                                               "imports": {
                                                   "properties": {
                                                       "entries": {
                                                           "properties": {
                                                               "data": {
                                                                   "type": "text"
                                                               }
                                                           }
                                                       }
                                                   }
                                               },
                                               "resources_manager": {
                                                   "properties": {
                                                       "icons": {
                                                           "properties": {
                                                               "pixels": {
                                                                   "type": "text"
                                                               }
                                                           }
                                                       }
                                                   }
                                               },
                                               "resources_tree": {
                                                   "properties": {
                                                       "childs": {
                                                           "properties": {
                                                               "childs": {
                                                                   "properties": {
                                                                       "childs": {
                                                                           "properties": {
                                                                               "hash": {
                                                                                   "type": "text"
                                                                               }
                                                                           }
                                                                       }
                                                                   }
                                                               }
                                                           }
                                                       }
                                                   }
                                               }
                                           }
                                       }
                                   }
                               }
                           }
                       }
                    }
               },
               "aliases": {
                   "malwaretl": {}
               }
            }
    es = _connect_to_es(host, user, password)
    es.indices.put_template(name="malwaretl_index_template", body=command)


if __name__ == "__main__":
    host = os.environ.get("ES_HOST")
    user = os.environ.get("ES_USERNAME")
    password = os.environ.get("ES_PASSWORD")
    set_configurations(host, user, password)
