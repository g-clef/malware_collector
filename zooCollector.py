import datetime
from typing import Tuple

from malwaretl_stoq_transformer import transformer

from malware_collector import MalwareCollector


class ZooCollector(MalwareCollector):
    # plan: git checkout https://github.com/ytisf/theZoo/tree/master/malwares/Binaries
    # to the base paththen walk through each folder and unzip the files that contain
    # the actual malware.
    git_url = "https://github.com/ytisf/theZoo.git"

    def __init__(self):
        super(ZooCollector, self).__init__()
        self.base_path = self.configfile.get("theZoo", "git_path")

    def get(self) -> Tuple[bool, str]:
        return self.pull_from_repo(self.base_path, self.git_url)


if __name__ == "__main__":
    zooSync = ZooCollector()
    changed, last_commit = zooSync.get()
    print(f"sync complete. New files: {changed}")
    if changed:
        stoq, metadata = transformer.init_thezoo(scan_mode=True)
        metadata.extra_data['collection_time'] = datetime.datetime.utcnow().isoformat()
        changed_files = zooSync.get_changed_files_between_pulls(last_commit)
        zooSync.scan_downloaded_files(stoq, metadata, changed_files)
    print("done.")
