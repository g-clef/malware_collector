import os
import requests
from bs4 import BeautifulSoup

from malware_collector import MalwareCollector


class VXUGCollector(MalwareCollector):
    # collect malware from https://vxug.fakedoma.in/samples/

    base_url = "https://vxug.fakedoma.in"
    list_url = base_url + "/samples.html"

    def __init__(self):
        super(VXUGCollector, self).__init__()
        self.base_path = self.configfile.get("VXUG", "path")

    def get(self):
        base_list = requests.get(self.list_url)
        soup = BeautifulSoup(base_list.content, features='html.parser')
        links = soup.find_all("a")
        for a in links:
            if "href" not in a.attrs:
                continue
            href = a.attrs['href']
            if not href.startswith("/samples"):
                continue
            if not href.endswith(".7z"):
                continue
            name = a.text
            if name.endswith(".txt"):
                continue
            download_url = self.base_url + href
            print(f"getting {name} from {download_url}")
            target_dir = os.path.join(self.base_path, name)
            if not os.path.exists(target_dir):
                os.mkdir(target_dir)
            full_saved_path = os.path.join(target_dir, name + ".7z")
            if not os.path.exists(full_saved_path):
                response = requests.get(download_url, stream=True)
                with open(full_saved_path, "wb") as fileHandle:
                    for chunk in response.iter_content(chunk_size=8192):
                        fileHandle.write(chunk)


if __name__ == "__main__":
    vx = VXUGCollector()
    vx.get()
