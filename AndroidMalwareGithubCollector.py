import datetime
from malware_collector import MalwareCollector
from malwaretl_stoq_transformer import transformer


class AndroidMalwareGithubCollector(MalwareCollector):
    # plan: git sync
    repo_url = "https://github.com/ashishb/android-malware.git"

    def __init__(self):
        super(AndroidMalwareGithubCollector, self).__init__()
        self.base_path = self.configfile.get("AndroidMalwareGithub", "git_path")

    def get(self):
        return self.pull_from_repo(self.base_path, self.repo_url)


if __name__ == "__main__":
    android = AndroidMalwareGithubCollector()
    changed, previous_commit = android.get()
    print(f"androidmalware sync complete. New files: {changed}")
    if changed:
        stoq, metadata = transformer.init_github_android(scan_mode=True)
        changed_files = android.get_changed_files_between_pulls(previous_commit)
        metadata.extra_data['collection_time'] = datetime.datetime.utcnow().isoformat()
        android.scan_downloaded_files(stoq, metadata, changed_files)
    print("done")
