import datetime
import os

from typing import List

import requests
from bs4 import BeautifulSoup
from malwaretl_stoq_transformer import transformer

from malware_collector import MalwareCollector


class MalwareBazaarCollector(MalwareCollector):
    # collect malware from https://bazaar.abuse.ch/

    base_url = "https://datalake.abuse.ch/malware-bazaar/daily/"

    def __init__(self):
        super(MalwareBazaarCollector, self).__init__()
        self.base_path = self.configfile.get("MalwareBazaar", "path")

    def get(self) -> List[str]:
        base_list = requests.get(self.base_url, timeout=60)
        soup = BeautifulSoup(base_list.content, features='html.parser')
        table = soup.find("table")
        fetched = list()
        for row in table.find_all('tr'):
            th = row.find("th")
            if th is not None:
                continue
            a = row.find("a")
            if "href" not in a.attrs:
                continue
            href = a.attrs['href']
            if not href.endswith(".zip"):
                continue
            name = a.text
            download_url = self.base_url + href
            print(f"getting {name} from {download_url}")
            target_dir = os.path.join(self.base_path, name)
            if not os.path.exists(target_dir):
                os.mkdir(target_dir)
            full_saved_path = os.path.join(target_dir, name + ".zip")
            if not os.path.exists(full_saved_path):
                response = requests.get(download_url, stream=True, timeout=100)
                with open(full_saved_path, "wb") as fileHandle:
                    for chunk in response.iter_content(chunk_size=8192):
                        fileHandle.write(chunk)
                print(f"fetched {name}")
                fetched.append(full_saved_path)
        return fetched


if __name__ == "__main__":
    bazaar = MalwareBazaarCollector()
    files_downloaded = bazaar.get()
    if files_downloaded:
        # iterate over the new files, hand each one to stoq.
        input_mode = transformer.InputMode.manual
        output_mode = transformer.OutputMode.silent
        stoq, metadata = transformer.init_vxug(input_mode=input_mode, output_mode=output_mode)
        metadata.extra_data['collection_time'] = datetime.datetime.utcnow().isoformat()
        bazaar.scan_downloaded_files(stoq, metadata, files_downloaded)
    print(f"completed. grabbed {len(files_downloaded)} new files")
